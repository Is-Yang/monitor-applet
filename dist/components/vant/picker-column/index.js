"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var component_1 = require('./../common/component.js');
var utils_1 = require('./../common/utils.js');
var DEFAULT_DURATION = 200;
component_1.VantComponent({
    classes: ['active-class'],
    props: {
        valueKey: String,
        className: String,
        itemHeight: Number,
        visibleItemCount: Number,
        initialOptions: {
            type: Array,
            value: []
        },
        defaultIndex: {
            type: Number,
            value: 0,
            observer: function observer(value) {
                this.setIndex(value);
            }
        }
    },
    data: {
        startY: 0,
        offset: 0,
        duration: 0,
        startOffset: 0,
        options: [],
        currentIndex: 0
    },
    created: function created() {
        var _this = this;
        var _a = this.data,
            defaultIndex = _a.defaultIndex,
            initialOptions = _a.initialOptions;
        this.set({
            currentIndex: defaultIndex,
            options: initialOptions
        }).then(function () {
            _this.setIndex(defaultIndex);
        });
    },
    methods: {
        getCount: function getCount() {
            return this.data.options.length;
        },
        onTouchStart: function onTouchStart(event) {
            this.setData({
                startY: event.touches[0].clientY,
                startOffset: this.data.offset,
                duration: 0
            });
        },
        onTouchMove: function onTouchMove(event) {
            var data = this.data;
            var deltaY = event.touches[0].clientY - data.startY;
            this.setData({
                offset: utils_1.range(data.startOffset + deltaY, -(this.getCount() * data.itemHeight), data.itemHeight)
            });
        },
        onTouchEnd: function onTouchEnd() {
            var data = this.data;
            if (data.offset !== data.startOffset) {
                this.setData({ duration: DEFAULT_DURATION });
                var index = utils_1.range(Math.round(-data.offset / data.itemHeight), 0, this.getCount() - 1);
                this.setIndex(index, true);
            }
        },
        onClickItem: function onClickItem(event) {
            var index = event.currentTarget.dataset.index;
            this.setIndex(index, true);
        },
        adjustIndex: function adjustIndex(index) {
            var data = this.data;
            var count = this.getCount();
            index = utils_1.range(index, 0, count);
            for (var i = index; i < count; i++) {
                if (!this.isDisabled(data.options[i])) return i;
            }
            for (var i = index - 1; i >= 0; i--) {
                if (!this.isDisabled(data.options[i])) return i;
            }
        },
        isDisabled: function isDisabled(option) {
            return utils_1.isObj(option) && option.disabled;
        },
        getOptionText: function getOptionText(option) {
            var data = this.data;
            return utils_1.isObj(option) && data.valueKey in option ? option[data.valueKey] : option;
        },
        setIndex: function setIndex(index, userAction) {
            var _this = this;
            var data = this.data;
            index = this.adjustIndex(index) || 0;
            var offset = -index * data.itemHeight;
            if (index !== data.currentIndex) {
                return this.set({ offset: offset, currentIndex: index }).then(function () {
                    userAction && _this.$emit('change', index);
                });
            }
            return this.set({ offset: offset });
        },
        setValue: function setValue(value) {
            var options = this.data.options;
            for (var i = 0; i < options.length; i++) {
                if (this.getOptionText(options[i]) === value) {
                    return this.setIndex(i);
                }
            }
            return Promise.resolve();
        },
        getValue: function getValue() {
            var data = this.data;
            return data.options[data.currentIndex];
        }
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY29tcG9uZW50XzEiLCJyZXF1aXJlIiwidXRpbHNfMSIsIkRFRkFVTFRfRFVSQVRJT04iLCJWYW50Q29tcG9uZW50IiwiY2xhc3NlcyIsInByb3BzIiwidmFsdWVLZXkiLCJTdHJpbmciLCJjbGFzc05hbWUiLCJpdGVtSGVpZ2h0IiwiTnVtYmVyIiwidmlzaWJsZUl0ZW1Db3VudCIsImluaXRpYWxPcHRpb25zIiwidHlwZSIsIkFycmF5IiwiZGVmYXVsdEluZGV4Iiwib2JzZXJ2ZXIiLCJzZXRJbmRleCIsImRhdGEiLCJzdGFydFkiLCJvZmZzZXQiLCJkdXJhdGlvbiIsInN0YXJ0T2Zmc2V0Iiwib3B0aW9ucyIsImN1cnJlbnRJbmRleCIsImNyZWF0ZWQiLCJfdGhpcyIsIl9hIiwic2V0IiwidGhlbiIsIm1ldGhvZHMiLCJnZXRDb3VudCIsImxlbmd0aCIsIm9uVG91Y2hTdGFydCIsImV2ZW50Iiwic2V0RGF0YSIsInRvdWNoZXMiLCJjbGllbnRZIiwib25Ub3VjaE1vdmUiLCJkZWx0YVkiLCJyYW5nZSIsIm9uVG91Y2hFbmQiLCJpbmRleCIsIk1hdGgiLCJyb3VuZCIsIm9uQ2xpY2tJdGVtIiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJhZGp1c3RJbmRleCIsImNvdW50IiwiaSIsImlzRGlzYWJsZWQiLCJvcHRpb24iLCJpc09iaiIsImRpc2FibGVkIiwiZ2V0T3B0aW9uVGV4dCIsInVzZXJBY3Rpb24iLCIkZW1pdCIsInNldFZhbHVlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRWYWx1ZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0FBLE9BQU9DLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDLEVBQUVDLE9BQU8sSUFBVCxFQUE3QztBQUNBLElBQUlDLGNBQWNDLFFBQVEscUJBQVIsQ0FBbEI7QUFDQSxJQUFJQyxV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Qk4sS0FBakIsS0FBMkIsQ0FBbkM7QUFDQSxnQkFBSXRCLFNBQVMsQ0FBQ3NCLEtBQUQsR0FBU3hCLEtBQUtULFVBQTNCO0FBQ0EsZ0JBQUlpQyxVQUFVeEIsS0FBS00sWUFBbkIsRUFBaUM7QUFDN0IsdUJBQU8sS0FBS0ksR0FBTCxDQUFTLEVBQUVSLFFBQVFBLE1BQVYsRUFBa0JJLGNBQWNrQixLQUFoQyxFQUFULEVBQWtEYixJQUFsRCxDQUF1RCxZQUFZO0FBQ3RFMkIsa0NBQWM5QixNQUFNK0IsS0FBTixDQUFZLFFBQVosRUFBc0JmLEtBQXRCLENBQWQ7QUFDSCxpQkFGTSxDQUFQO0FBR0g7QUFDRCxtQkFBTyxLQUFLZCxHQUFMLENBQVMsRUFBRVIsUUFBUUEsTUFBVixFQUFULENBQVA7QUFDSCxTQS9ESTtBQWdFTHNDLGtCQUFVLGtCQUFVNUQsS0FBVixFQUFpQjtBQUN2QixnQkFBSXlCLFVBQVUsS0FBS0wsSUFBTCxDQUFVSyxPQUF4QjtBQUNBLGlCQUFLLElBQUkyQixJQUFJLENBQWIsRUFBZ0JBLElBQUkzQixRQUFRUyxNQUE1QixFQUFvQ2tCLEdBQXBDLEVBQXlDO0FBQ3JDLG9CQUFJLEtBQUtLLGFBQUwsQ0FBbUJoQyxRQUFRMkIsQ0FBUixDQUFuQixNQUFtQ3BELEtBQXZDLEVBQThDO0FBQzFDLDJCQUFPLEtBQUttQixRQUFMLENBQWNpQyxDQUFkLENBQVA7QUFDSDtBQUNKO0FBQ0QsbUJBQU9TLFFBQVFDLE9BQVIsRUFBUDtBQUNILFNBeEVJO0FBeUVMQyxrQkFBVSxvQkFBWTtBQUNsQixnQkFBSTNDLE9BQU8sS0FBS0EsSUFBaEI7QUFDQSxtQkFBT0EsS0FBS0ssT0FBTCxDQUFhTCxLQUFLTSxZQUFsQixDQUFQO0FBQ0g7QUE1RUk7QUFyQ2EsQ0FBMUIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciBjb21wb25lbnRfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29tcG9uZW50XCIpO1xudmFyIHV0aWxzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzXCIpO1xudmFyIERFRkFVTFRfRFVSQVRJT04gPSAyMDA7XG5jb21wb25lbnRfMS5WYW50Q29tcG9uZW50KHtcbiAgICBjbGFzc2VzOiBbJ2FjdGl2ZS1jbGFzcyddLFxuICAgIHByb3BzOiB7XG4gICAgICAgIHZhbHVlS2V5OiBTdHJpbmcsXG4gICAgICAgIGNsYXNzTmFtZTogU3RyaW5nLFxuICAgICAgICBpdGVtSGVpZ2h0OiBOdW1iZXIsXG4gICAgICAgIHZpc2libGVJdGVtQ291bnQ6IE51bWJlcixcbiAgICAgICAgaW5pdGlhbE9wdGlvbnM6IHtcbiAgICAgICAgICAgIHR5cGU6IEFycmF5LFxuICAgICAgICAgICAgdmFsdWU6IFtdXG4gICAgICAgIH0sXG4gICAgICAgIGRlZmF1bHRJbmRleDoge1xuICAgICAgICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgICAgICAgdmFsdWU6IDAsXG4gICAgICAgICAgICBvYnNlcnZlcjogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRJbmRleCh2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGRhdGE6IHtcbiAgICAgICAgc3RhcnRZOiAwLFxuICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgIGR1cmF0aW9uOiAwLFxuICAgICAgICBzdGFydE9mZnNldDogMCxcbiAgICAgICAgb3B0aW9uczogW10sXG4gICAgICAgIGN1cnJlbnRJbmRleDogMFxuICAgIH0sXG4gICAgY3JlYXRlZDogZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB2YXIgX2EgPSB0aGlzLmRhdGEsIGRlZmF1bHRJbmRleCA9IF9hLmRlZmF1bHRJbmRleCwgaW5pdGlhbE9wdGlvbnMgPSBfYS5pbml0aWFsT3B0aW9ucztcbiAgICAgICAgdGhpcy5zZXQoe1xuICAgICAgICAgICAgY3VycmVudEluZGV4OiBkZWZhdWx0SW5kZXgsXG4gICAgICAgICAgICBvcHRpb25zOiBpbml0aWFsT3B0aW9uc1xuICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIF90aGlzLnNldEluZGV4KGRlZmF1bHRJbmRleCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgbWV0aG9kczoge1xuICAgICAgICBnZXRDb3VudDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS5vcHRpb25zLmxlbmd0aDtcbiAgICAgICAgfSxcbiAgICAgICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgc3RhcnRZOiBldmVudC50b3VjaGVzWzBdLmNsaWVudFksXG4gICAgICAgICAgICAgICAgc3RhcnRPZmZzZXQ6IHRoaXMuZGF0YS5vZmZzZXQsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICBvblRvdWNoTW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgICAgICAgIHZhciBkZWx0YVkgPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFkgLSBkYXRhLnN0YXJ0WTtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgb2Zmc2V0OiB1dGlsc18xLnJhbmdlKGRhdGEuc3RhcnRPZmZzZXQgKyBkZWx0YVksIC0odGhpcy5nZXRDb3VudCgpICogZGF0YS5pdGVtSGVpZ2h0KSwgZGF0YS5pdGVtSGVpZ2h0KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgaWYgKGRhdGEub2Zmc2V0ICE9PSBkYXRhLnN0YXJ0T2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgZHVyYXRpb246IERFRkFVTFRfRFVSQVRJT04gfSk7XG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gdXRpbHNfMS5yYW5nZShNYXRoLnJvdW5kKC1kYXRhLm9mZnNldCAvIGRhdGEuaXRlbUhlaWdodCksIDAsIHRoaXMuZ2V0Q291bnQoKSAtIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5kZXgoaW5kZXgsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBvbkNsaWNrSXRlbTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICB2YXIgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5kZXg7XG4gICAgICAgICAgICB0aGlzLnNldEluZGV4KGluZGV4LCB0cnVlKTtcbiAgICAgICAgfSxcbiAgICAgICAgYWRqdXN0SW5kZXg6IGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICAgICAgICB2YXIgY291bnQgPSB0aGlzLmdldENvdW50KCk7XG4gICAgICAgICAgICBpbmRleCA9IHV0aWxzXzEucmFuZ2UoaW5kZXgsIDAsIGNvdW50KTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmRleDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZChkYXRhLm9wdGlvbnNbaV0pKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmRleCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGlzYWJsZWQoZGF0YS5vcHRpb25zW2ldKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uIChvcHRpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB1dGlsc18xLmlzT2JqKG9wdGlvbikgJiYgb3B0aW9uLmRpc2FibGVkO1xuICAgICAgICB9LFxuICAgICAgICBnZXRPcHRpb25UZXh0OiBmdW5jdGlvbiAob3B0aW9uKSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgICAgICAgIHJldHVybiB1dGlsc18xLmlzT2JqKG9wdGlvbikgJiYgZGF0YS52YWx1ZUtleSBpbiBvcHRpb25cbiAgICAgICAgICAgICAgICA/IG9wdGlvbltkYXRhLnZhbHVlS2V5XVxuICAgICAgICAgICAgICAgIDogb3B0aW9uO1xuICAgICAgICB9LFxuICAgICAgICBzZXRJbmRleDogZnVuY3Rpb24gKGluZGV4LCB1c2VyQWN0aW9uKSB7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICAgICAgICBpbmRleCA9IHRoaXMuYWRqdXN0SW5kZXgoaW5kZXgpIHx8IDA7XG4gICAgICAgICAgICB2YXIgb2Zmc2V0ID0gLWluZGV4ICogZGF0YS5pdGVtSGVpZ2h0O1xuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSBkYXRhLmN1cnJlbnRJbmRleCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCh7IG9mZnNldDogb2Zmc2V0LCBjdXJyZW50SW5kZXg6IGluZGV4IH0pLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB1c2VyQWN0aW9uICYmIF90aGlzLiRlbWl0KCdjaGFuZ2UnLCBpbmRleCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQoeyBvZmZzZXQ6IG9mZnNldCB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLmRhdGEub3B0aW9ucztcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldE9wdGlvblRleHQob3B0aW9uc1tpXSkgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldEluZGV4KGkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgcmV0dXJuIGRhdGEub3B0aW9uc1tkYXRhLmN1cnJlbnRJbmRleF07XG4gICAgICAgIH1cbiAgICB9XG59KTtcbiJdfQ==