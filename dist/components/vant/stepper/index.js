"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var component_1 = require('./../common/component.js');
var utils_1 = require('./../common/utils.js');
var LONG_PRESS_START_TIME = 600;
var LONG_PRESS_INTERVAL = 200;
// add num and avoid float number
function add(num1, num2) {
    var cardinal = Math.pow(10, 10);
    return Math.round((num1 + num2) * cardinal) / cardinal;
}
component_1.VantComponent({
    field: true,
    classes: ['input-class', 'plus-class', 'minus-class'],
    props: {
        value: {
            type: null,
            observer: function observer(value) {
                if (value === '') {
                    return;
                }
                var newValue = this.range(value);
                if (typeof newValue === 'number' && +this.data.value !== newValue) {
                    this.setData({ value: newValue });
                }
            }
        },
        integer: Boolean,
        disabled: Boolean,
        inputWidth: {
            type: null,
            observer: function observer() {
                this.setData({
                    inputStyle: this.computeInputStyle()
                });
            }
        },
        buttonSize: {
            type: null,
            observer: function observer() {
                this.setData({
                    inputStyle: this.computeInputStyle(),
                    buttonStyle: this.computeButtonStyle()
                });
            }
        },
        asyncChange: Boolean,
        disableInput: Boolean,
        decimalLength: {
            type: Number,
            value: null
        },
        min: {
            type: null,
            value: 1
        },
        max: {
            type: null,
            value: Number.MAX_SAFE_INTEGER
        },
        step: {
            type: null,
            value: 1
        },
        showPlus: {
            type: Boolean,
            value: true
        },
        showMinus: {
            type: Boolean,
            value: true
        },
        disablePlus: Boolean,
        disableMinus: Boolean,
        longPress: {
            type: Boolean,
            value: true
        }
    },
    data: {
        focus: false,
        inputStyle: '',
        buttonStyle: ''
    },
    created: function created() {
        this.setData({
            value: this.range(this.data.value)
        });
    },
    methods: {
        isDisabled: function isDisabled(type) {
            if (type === 'plus') {
                return this.data.disabled || this.data.disablePlus || this.data.value >= this.data.max;
            }
            return this.data.disabled || this.data.disableMinus || this.data.value <= this.data.min;
        },
        onFocus: function onFocus(event) {
            this.$emit('focus', event.detail);
        },
        onBlur: function onBlur(event) {
            var value = this.range(this.data.value);
            this.triggerInput(value);
            this.$emit('blur', event.detail);
        },
        // limit value range
        range: function range(value) {
            value = String(value).replace(/[^0-9.-]/g, '');
            // format range
            value = value === '' ? 0 : +value;
            value = Math.max(Math.min(this.data.max, value), this.data.min);
            // format decimal
            if (utils_1.isDef(this.data.decimalLength)) {
                value = value.toFixed(this.data.decimalLength);
            }
            return value;
        },
        onInput: function onInput(event) {
            var _a = (event.detail || {}).value,
                value = _a === void 0 ? '' : _a;
            this.triggerInput(value);
        },
        onChange: function onChange() {
            var type = this.type;
            if (this.isDisabled(type)) {
                this.$emit('overlimit', type);
                return;
            }
            var diff = type === 'minus' ? -this.data.step : +this.data.step;
            var value = add(+this.data.value, diff);
            this.triggerInput(this.range(value));
            this.$emit(type);
        },
        longPressStep: function longPressStep() {
            var _this = this;
            this.longPressTimer = setTimeout(function () {
                _this.onChange();
                _this.longPressStep();
            }, LONG_PRESS_INTERVAL);
        },
        onTap: function onTap(event) {
            var type = event.currentTarget.dataset.type;
            this.type = type;
            this.onChange();
        },
        onTouchStart: function onTouchStart(event) {
            var _this = this;
            if (!this.data.longPress) {
                return;
            }
            clearTimeout(this.longPressTimer);
            var type = event.currentTarget.dataset.type;
            this.type = type;
            this.isLongPress = false;
            this.longPressTimer = setTimeout(function () {
                _this.isLongPress = true;
                _this.onChange();
                _this.longPressStep();
            }, LONG_PRESS_START_TIME);
        },
        onTouchEnd: function onTouchEnd() {
            if (!this.data.longPress) {
                return;
            }
            clearTimeout(this.longPressTimer);
        },
        triggerInput: function triggerInput(value) {
            this.setData({
                value: this.data.asyncChange ? this.data.value : value
            });
            this.$emit('change', value);
        },
        computeInputStyle: function computeInputStyle() {
            var style = '';
            if (this.data.inputWidth) {
                style = "width: " + utils_1.addUnit(this.data.inputWidth) + ";";
            }
            if (this.data.buttonSize) {
                style += "height: " + utils_1.addUnit(this.data.buttonSize) + ";";
            }
            return style;
        },
        computeButtonStyle: function computeButtonStyle() {
            var style = '';
            var size = utils_1.addUnit(this.data.buttonSize);
            if (this.data.buttonSize) {
                style = "width: " + size + ";height: " + size + ";";
            }
            return style;
        }
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY29tcG9uZW50XzEiLCJyZXF1aXJlIiwidXRpbHNfMSIsIkxPTkdfUFJFU1NfU1RBUlRfVElNRSIsIkxPTkdfUFJFU1NfSU5URVJWQUwiLCJhZGQiLCJudW0xIiwibnVtMiIsImNhcmRpbmFsIiwiTWF0aCIsInBvdyIsInJvdW5kIiwiVmFudENvbXBvbmVudCIsImZpZWxkIiwiY2xhc3NlcyIsInByb3BzIiwidHlwZSIsIm9ic2VydmVyIiwibmV3VmFsdWUiLCJyYW5nZSIsImRhdGEiLCJzZXREYXRhIiwiaW50ZWdlciIsIkJvb2xlYW4iLCJkaXNhYmxlZCIsImlucHV0V2lkdGgiLCJpbnB1dFN0eWxlIiwiY29tcHV0ZUlucHV0U3R5bGUiLCJidXR0b25TaXplIiwiYnV0dG9uU3R5bGUiLCJjb21wdXRlQnV0dG9uU3R5bGUiLCJhc3luY0NoYW5nZSIsImRpc2FibGVJbnB1dCIsImRlY2ltYWxMZW5ndGgiLCJOdW1iZXIiLCJtaW4iLCJtYXgiLCJNQVhfU0FGRV9JTlRFR0VSIiwic3RlcCIsInNob3dQbHVzIiwic2hvd01pbnVzIiwiZGlzYWJsZVBsdXMiLCJkaXNhYmxlTWludXMiLCJsb25nUHJlc3MiLCJmb2N1cyIsImNyZWF0ZWQiLCJtZXRob2RzIiwiaXNEaXNhYmxlZCIsIm9uRm9jdXMiLCJldmVudCIsIiRlbWl0IiwiZGV0YWlsIiwib25CbHVyIiwidHJpZ2dlcklucHV0IiwiU3RyaW5nIiwicmVwbGFjZSIsImlzRGVmIiwidG9GaXhlZCIsIm9uSW5wdXQiLCJfYSIsIm9uQ2hhbmdlIiwiZGlmZiIsImxvbmdQcmVzc1N0ZXAiLCJfdGhpcyIsImxvbmdQcmVzc1RpbWVyIiwic2V0VGltZW91dCIsIm9uVGFwIiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJvblRvdWNoU3RhcnQiLCJjbGVhclRpbWVvdXQiLCJpc0xvbmdQcmVzcyIs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QWlGTDRCLDJCQUFtQiw2QkFBWTtBQUMzQixnQkFBSThDLFFBQVEsRUFBWjtBQUNBLGdCQUFJLEtBQUtyRCxJQUFMLENBQVVLLFVBQWQsRUFBMEI7QUFDdEJnRCx3QkFBUSxZQUFZdkUsUUFBUXdFLE9BQVIsQ0FBZ0IsS0FBS3RELElBQUwsQ0FBVUssVUFBMUIsQ0FBWixHQUFvRCxHQUE1RDtBQUNIO0FBQ0QsZ0JBQUksS0FBS0wsSUFBTCxDQUFVUSxVQUFkLEVBQTBCO0FBQ3RCNkMseUJBQVMsYUFBYXZFLFFBQVF3RSxPQUFSLENBQWdCLEtBQUt0RCxJQUFMLENBQVVRLFVBQTFCLENBQWIsR0FBcUQsR0FBOUQ7QUFDSDtBQUNELG1CQUFPNkMsS0FBUDtBQUNILFNBMUZJO0FBMkZMM0MsNEJBQW9CLDhCQUFZO0FBQzVCLGdCQUFJMkMsUUFBUSxFQUFaO0FBQ0EsZ0JBQUlFLE9BQU96RSxRQUFRd0UsT0FBUixDQUFnQixLQUFLdEQsSUFBTCxDQUFVUSxVQUExQixDQUFYO0FBQ0EsZ0JBQUksS0FBS1IsSUFBTCxDQUFVUSxVQUFkLEVBQTBCO0FBQ3RCNkMsd0JBQVEsWUFBWUUsSUFBWixHQUFtQixXQUFuQixHQUFpQ0EsSUFBakMsR0FBd0MsR0FBaEQ7QUFDSDtBQUNELG1CQUFPRixLQUFQO0FBQ0g7QUFsR0k7QUE5RWEsQ0FBMUIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciBjb21wb25lbnRfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29tcG9uZW50XCIpO1xudmFyIHV0aWxzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzXCIpO1xudmFyIExPTkdfUFJFU1NfU1RBUlRfVElNRSA9IDYwMDtcbnZhciBMT05HX1BSRVNTX0lOVEVSVkFMID0gMjAwO1xuLy8gYWRkIG51bSBhbmQgYXZvaWQgZmxvYXQgbnVtYmVyXG5mdW5jdGlvbiBhZGQobnVtMSwgbnVtMikge1xuICAgIHZhciBjYXJkaW5hbCA9IE1hdGgucG93KDEwLCAxMCk7XG4gICAgcmV0dXJuIE1hdGgucm91bmQoKG51bTEgKyBudW0yKSAqIGNhcmRpbmFsKSAvIGNhcmRpbmFsO1xufVxuY29tcG9uZW50XzEuVmFudENvbXBvbmVudCh7XG4gICAgZmllbGQ6IHRydWUsXG4gICAgY2xhc3NlczogWydpbnB1dC1jbGFzcycsICdwbHVzLWNsYXNzJywgJ21pbnVzLWNsYXNzJ10sXG4gICAgcHJvcHM6IHtcbiAgICAgICAgdmFsdWU6IHtcbiAgICAgICAgICAgIHR5cGU6IG51bGwsXG4gICAgICAgICAgICBvYnNlcnZlcjogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAnJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRoaXMucmFuZ2UodmFsdWUpO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VmFsdWUgPT09ICdudW1iZXInICYmICt0aGlzLmRhdGEudmFsdWUgIT09IG5ld1ZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IHZhbHVlOiBuZXdWYWx1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBpbnRlZ2VyOiBCb29sZWFuLFxuICAgICAgICBkaXNhYmxlZDogQm9vbGVhbixcbiAgICAgICAgaW5wdXRXaWR0aDoge1xuICAgICAgICAgICAgdHlwZTogbnVsbCxcbiAgICAgICAgICAgIG9ic2VydmVyOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRTdHlsZTogdGhpcy5jb21wdXRlSW5wdXRTdHlsZSgpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBidXR0b25TaXplOiB7XG4gICAgICAgICAgICB0eXBlOiBudWxsLFxuICAgICAgICAgICAgb2JzZXJ2ZXI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpbnB1dFN0eWxlOiB0aGlzLmNvbXB1dGVJbnB1dFN0eWxlKCksXG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvblN0eWxlOiB0aGlzLmNvbXB1dGVCdXR0b25TdHlsZSgpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGFzeW5jQ2hhbmdlOiBCb29sZWFuLFxuICAgICAgICBkaXNhYmxlSW5wdXQ6IEJvb2xlYW4sXG4gICAgICAgIGRlY2ltYWxMZW5ndGg6IHtcbiAgICAgICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgICAgIHZhbHVlOiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIG1pbjoge1xuICAgICAgICAgICAgdHlwZTogbnVsbCxcbiAgICAgICAgICAgIHZhbHVlOiAxXG4gICAgICAgIH0sXG4gICAgICAgIG1heDoge1xuICAgICAgICAgICAgdHlwZTogbnVsbCxcbiAgICAgICAgICAgIHZhbHVlOiBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUlxuICAgICAgICB9LFxuICAgICAgICBzdGVwOiB7XG4gICAgICAgICAgICB0eXBlOiBudWxsLFxuICAgICAgICAgICAgdmFsdWU6IDFcbiAgICAgICAgfSxcbiAgICAgICAgc2hvd1BsdXM6IHtcbiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICAgICAgICB2YWx1ZTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBzaG93TWludXM6IHtcbiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICAgICAgICB2YWx1ZTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBkaXNhYmxlUGx1czogQm9vbGVhbixcbiAgICAgICAgZGlzYWJsZU1pbnVzOiBCb29sZWFuLFxuICAgICAgICBsb25nUHJlc3M6IHtcbiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICAgICAgICB2YWx1ZTogdHJ1ZVxuICAgICAgICB9LFxuICAgIH0sXG4gICAgZGF0YToge1xuICAgICAgICBmb2N1czogZmFsc2UsXG4gICAgICAgIGlucHV0U3R5bGU6ICcnLFxuICAgICAgICBidXR0b25TdHlsZTogJydcbiAgICB9LFxuICAgIGNyZWF0ZWQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHZhbHVlOiB0aGlzLnJhbmdlKHRoaXMuZGF0YS52YWx1ZSlcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBtZXRob2RzOiB7XG4gICAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uICh0eXBlKSB7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3BsdXMnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS5kaXNhYmxlZCB8fCB0aGlzLmRhdGEuZGlzYWJsZVBsdXMgfHwgdGhpcy5kYXRhLnZhbHVlID49IHRoaXMuZGF0YS5tYXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhLmRpc2FibGVkIHx8IHRoaXMuZGF0YS5kaXNhYmxlTWludXMgfHwgdGhpcy5kYXRhLnZhbHVlIDw9IHRoaXMuZGF0YS5taW47XG4gICAgICAgIH0sXG4gICAgICAgIG9uRm9jdXM6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgdGhpcy4kZW1pdCgnZm9jdXMnLCBldmVudC5kZXRhaWwpO1xuICAgICAgICB9LFxuICAgICAgICBvbkJsdXI6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5yYW5nZSh0aGlzLmRhdGEudmFsdWUpO1xuICAgICAgICAgICAgdGhpcy50cmlnZ2VySW5wdXQodmFsdWUpO1xuICAgICAgICAgICAgdGhpcy4kZW1pdCgnYmx1cicsIGV2ZW50LmRldGFpbCk7XG4gICAgICAgIH0sXG4gICAgICAgIC8vIGxpbWl0IHZhbHVlIHJhbmdlXG4gICAgICAgIHJhbmdlOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlKS5yZXBsYWNlKC9bXjAtOS4tXS9nLCAnJyk7XG4gICAgICAgICAgICAvLyBmb3JtYXQgcmFuZ2VcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgPT09ICcnID8gMCA6ICt2YWx1ZTtcbiAgICAgICAgICAgIHZhbHVlID0gTWF0aC5tYXgoTWF0aC5taW4odGhpcy5kYXRhLm1heCwgdmFsdWUpLCB0aGlzLmRhdGEubWluKTtcbiAgICAgICAgICAgIC8vIGZvcm1hdCBkZWNpbWFsXG4gICAgICAgICAgICBpZiAodXRpbHNfMS5pc0RlZih0aGlzLmRhdGEuZGVjaW1hbExlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRvRml4ZWQodGhpcy5kYXRhLmRlY2ltYWxMZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9LFxuICAgICAgICBvbklucHV0OiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHZhciBfYSA9IChldmVudC5kZXRhaWwgfHwge30pLnZhbHVlLCB2YWx1ZSA9IF9hID09PSB2b2lkIDAgPyAnJyA6IF9hO1xuICAgICAgICAgICAgdGhpcy50cmlnZ2VySW5wdXQodmFsdWUpO1xuICAgICAgICB9LFxuICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHR5cGUgPSB0aGlzLnR5cGU7XG4gICAgICAgICAgICBpZiAodGhpcy5pc0Rpc2FibGVkKHR5cGUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy4kZW1pdCgnb3ZlcmxpbWl0JywgdHlwZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGRpZmYgPSB0eXBlID09PSAnbWludXMnID8gLXRoaXMuZGF0YS5zdGVwIDogK3RoaXMuZGF0YS5zdGVwO1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gYWRkKCt0aGlzLmRhdGEudmFsdWUsIGRpZmYpO1xuICAgICAgICAgICAgdGhpcy50cmlnZ2VySW5wdXQodGhpcy5yYW5nZSh2YWx1ZSkpO1xuICAgICAgICAgICAgdGhpcy4kZW1pdCh0eXBlKTtcbiAgICAgICAgfSxcbiAgICAgICAgbG9uZ1ByZXNzU3RlcDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMubG9uZ1ByZXNzVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5vbkNoYW5nZSgpO1xuICAgICAgICAgICAgICAgIF90aGlzLmxvbmdQcmVzc1N0ZXAoKTtcbiAgICAgICAgICAgIH0sIExPTkdfUFJFU1NfSU5URVJWQUwpO1xuICAgICAgICB9LFxuICAgICAgICBvblRhcDogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICB2YXIgdHlwZSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC50eXBlO1xuICAgICAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTtcbiAgICAgICAgfSxcbiAgICAgICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZGF0YS5sb25nUHJlc3MpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5sb25nUHJlc3NUaW1lcik7XG4gICAgICAgICAgICB2YXIgdHlwZSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC50eXBlO1xuICAgICAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgICAgIHRoaXMuaXNMb25nUHJlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMubG9uZ1ByZXNzVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5pc0xvbmdQcmVzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgX3RoaXMub25DaGFuZ2UoKTtcbiAgICAgICAgICAgICAgICBfdGhpcy5sb25nUHJlc3NTdGVwKCk7XG4gICAgICAgICAgICB9LCBMT05HX1BSRVNTX1NUQVJUX1RJTUUpO1xuICAgICAgICB9LFxuICAgICAgICBvblRvdWNoRW5kOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZGF0YS5sb25nUHJlc3MpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5sb25nUHJlc3NUaW1lcik7XG4gICAgICAgIH0sXG4gICAgICAgIHRyaWdnZXJJbnB1dDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLmRhdGEuYXN5bmNDaGFuZ2UgPyB0aGlzLmRhdGEudmFsdWUgOiB2YWx1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLiRlbWl0KCdjaGFuZ2UnLCB2YWx1ZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXB1dGVJbnB1dFN0eWxlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgc3R5bGUgPSAnJztcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEuaW5wdXRXaWR0aCkge1xuICAgICAgICAgICAgICAgIHN0eWxlID0gXCJ3aWR0aDogXCIgKyB1dGlsc18xLmFkZFVuaXQodGhpcy5kYXRhLmlucHV0V2lkdGgpICsgXCI7XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhLmJ1dHRvblNpemUpIHtcbiAgICAgICAgICAgICAgICBzdHlsZSArPSBcImhlaWdodDogXCIgKyB1dGlsc18xLmFkZFVuaXQodGhpcy5kYXRhLmJ1dHRvblNpemUpICsgXCI7XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gc3R5bGU7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXB1dGVCdXR0b25TdHlsZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHN0eWxlID0gJyc7XG4gICAgICAgICAgICB2YXIgc2l6ZSA9IHV0aWxzXzEuYWRkVW5pdCh0aGlzLmRhdGEuYnV0dG9uU2l6ZSk7XG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhLmJ1dHRvblNpemUpIHtcbiAgICAgICAgICAgICAgICBzdHlsZSA9IFwid2lkdGg6IFwiICsgc2l6ZSArIFwiO2hlaWdodDogXCIgKyBzaXplICsgXCI7XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gc3R5bGU7XG4gICAgICAgIH1cbiAgICB9XG59KTtcbiJdfQ==